<include file="public/header" title="填写订单" body="g4"/>
<include file="public/header_nav" title="填写订单" href="javascript:void(0);" back="back"/>
<script src="__PUBLIC__/js/md5.min.js"></script>
<script type="text/javascript" src="__STATIC__/js/date.js"></script>
<script type="text/javascript" src="//api.map.baidu.com/api?ak=iR2qhnXd5vrFI9wUuIRG9AWGIqykVNok&type=lite&v=1.0"></script>
<style type="text/css">
	.bg_time{
		width: 100%;
		height: 100%;
		background-color:rgba(0,0,0,0.4);
		position: absolute;
		top: 0;
		z-index: 999999999;		
	}
	.bg_time img{
		position: absolute;
		left: 50%;
		top: 50%;
		transform: translate(-50%,-50%);

	}
</style>
<div id="wrapBody">
    <div id="pagePay">
        <form name="cart2_form" id="cart2_form" method="post">
            <input type="hidden" name="is_virtual" value="{$cartList[0]['goods']['is_virtual']?$cartList[0]['goods']['is_virtual']:0}">
            <input type="hidden" name="coupon_id" value=""/>
            <input type="hidden" id="wap_invoice_title" name="invoice_title" value="个人">
            <input type="hidden" id="wap_taxpayer" name="taxpayer" value="">
            <input type="hidden" id="invoice_desc" name="invoice_desc" value="商品明细">
            <input type="hidden" name="address_id" value="" autocomplete="off"/> <!--收货地址id-->
            <input type="hidden" name="pay_points" value="" autocomplete="off">
            <input type="hidden" name="user_money" value="" autocomplete="off">
            <input type="hidden" name="auth_code" value="{$Think.config.AUTH_CODE}"/>
            <!--立即购买才会用到-s-->
            <input type="hidden" name="action" value="{$Request.param.action}">
            <input type="hidden" name="goods_id" value="{$Request.param.goods_id}">
            <input type="hidden" name="item_id" value="{$Request.param.item_id}">
            <input type="hidden" name="goods_num" value="{$Request.param.goods_num}">
            <!--立即购买才会用到-e-->
            <input type="hidden" name="pay_pwd" value=""/>
            <input type="hidden" name="user_note" value="">
            <input type="hidden" name="consignee" value="">
            <input type="hidden" name="mobile" value="">
            <input type="hidden" name="shop_id" value="">
            <input type="hidden" name="take_time" value="">
        </form>
        <!--地址-s-->
        <div class="edit_gtfix shipping_div" id="addressDefault">
            <div class="namephone fl">
                <div class="top">
                    <div class="le fl" id="default_address_consignee"></div>
                    <div class="lr fl" id="default_address_mobile"></div>
                </div>
                <div class="bot">
                    <i class="dwgp"></i>
                    <span id="default_address_text"></span>
                </div>
            </div>
            <div class="fr youjter">
                <i class="Mright"></i>
            </div>
            <div class="ttrebu">
                <img src="__STATIC__/images/tt.png"/>
            </div>
        </div>
        <!--地址-e-->
        <!--商品信息-s-->
        <div class="ord_list fill-orderlist p">
            <div class="maleri30">
                <volist name="cartList" id="cart">
                    <div class="shopprice">
                        <div class="img_or fl"><img src="{$cart['goods']['original_img']|goods_thum_images=100,100}"/></div>
                        <div class="fon_or fl">
                            <h2 class="similar-product-text">{$cart[goods_name]}</h2>

                            <div>{$cart[spec_key_name]}</div>
                        </div>
                        <div class="price_or fr">
                            <p class="red"><span>￥</span><span>{$cart[member_goods_price]}</span></p>
                            <p class="ligfill">x{$cart[goods_num]}</p>
                        </div>
                    </div>
                </volist>
            </div>
        </div>
        <!--商品信息-e-->
 
        <!--卖家留言-s-->
        <div class="customer-messa">
            <div class="other-item no_shipping_div">
                <div class="other-left">手机 :</div>
                <div class="other-right leave-word-box">
                    <input class="leave-word tapassa user_note_txt" id="mobile_check" maxlength="13" placeholder="请输入手机号码,接受兑换码"/>
                </div>
            </div>
            <div class="maleri30">
                <p>用户备注（50字）</p>
                <textarea class="tapassa" id="user_note" maxlength="50" placeholder="选填"></textarea>
                <span class="xianzd"><em id="zero">50</em>/50</span>
            </div>
        </div>
        <!--卖家留言-e-->
        <!--订单金额-s-->
        <div class="information_dr ">
            <div class="z-monry">
                <div class="maleri30">
                  
                    <div class="p z-monry-cont">
                        <div class="fl">
                            商品金额
                        </div>
                        <div class="fr">
                            <a> ￥<span id="total_fee">{$total_price}</span>元</a>
                        </div>
                    </div>
                    <div class="p z-monry-cont shipping_div">
                        <div class="fl">
                            配送费用
                        </div>
                        <div class="fr">
                            <a> ￥<span id="postFee">0</span>元</a>
                        </div>
                    </div>
                  
                </div>
            </div>
        </div>
        <!--订单金额 -e-->
        <!--提交订单-s-->
        <div class="mask-filter-div" style="display: none;"></div>
        <div class="payit fillpay ma-to-20">
            <div class="fr submit_price">
                <a href="javascript:void(0)" onclick="submit_order()">提交订单</a>
            </div>
            <div class="fl">
                <p><span class="pmo">应付金额：</span>￥<span id="payables">0</span><span></span></p>
            </div>
        </div>
        <!--提交订单-e-->
    </div>
  
  
   
    <div id="addressList" style="display: none">
        <!--地址-s-->
        <div class="dizhi-pop">
            <div class="z-Package-hrader">
                <i class="z-Package-icon Package-icon-close" id="address_list_back"></i>
                <h5>选择地址</h5>
            </div>
            <div id="address_list_html" style="height: 19.5rem;overflow:  scroll;"></div>
            <!--地址-e-->
            <div class="createnew ">
                <a id="add_address" >+新建地址</a>
            </div>
        </div>
    </div>
 
    <div id="addressAdd" style="display: none">
        <div class="dizhi-pop">
            <div class="z-Package-hrader">
                <i class="z-Package-icon Package-icon-close" id="address_add_back"></i>
                <h5>新建/编辑地址</h5>
            </div>
            <div class="floor my p edit">
                <form id="address_form">
                    <input type="hidden" value="" name="address_id"/>
                    <input type="hidden" value="" name="province"/>
                    <input type="hidden" value="" name="city"/>
                    <input type="hidden" value="" name="district"/>

                    <div class="content">
                        <div class="floor list7">
                            <div class="myorder p">
                                <div class="content30">
                                    <a href="javascript:void(0)">
                                        <div class="order">
                                            <div class="fl">
                                                <span>收货人:</span>
                                            </div>
                                            <div class="fl">
                                                <input type="text" value="" name="consignee"/>
                                                <span class="err" id="err_address_consignee"></span>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <div class="myorder p">
                                <div class="content30">
                                    <a href="javascript:void(0)">
                                        <div class="order">
                                            <div class="fl">
                                                <span>手机号码:</span>
                                            </div>
                                            <div class="fl">
                                                <input type="tel" value="" name="mobile" onkeyup="this.value=this.value.replace(/[^\d]/g,'')"/>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <div class="myorder p">
                                <div class="content30">
                                    <a href="javascript:void(0)" onclick="location_address(this);">
                                        <div class="order">
                                            <div class="fl">
                                                <span>所在地区: </span>
                                            </div>
                                            <div class="fl">
                                                <span id="area"></span>
                                            </div>
                                            <div class="fr">
                                                <i class="Mright"></i>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <div class="myorder p">
                                <div class="content30">
                                    <a href="javascript:void(0)">
                                        <div class="order">
                                            <div class="fl">
                                                <span>详细地址:</span>
                                            </div>
                                            <div class="fl">
                                                <input type="text" value="" name="address"/>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="createnew newAjax">
                        <a id="address_form_confirm">确认</a>
                    </div>
                </form>
            </div>
            <!--选择地区-s-->
            <div class="container">
                <div class="city">
                    <div class="screen_wi_loc">
                        <div class="classreturn loginsignup">
                            <div class="content">
                                <div class="ds-in-bl return seac_retu">
                                    <a href="javascript:void(0);" onclick="close_location();"><img src="__STATIC__/images/return.png" alt="返回"></a>
                                </div>
                                <div class="ds-in-bl search center">
                                    <span class="sx_jsxz">选择地区</span>
                                </div>
                                <div class="ds-in-bl suce_ok">
                                    <a href="javascript:void(0);">&nbsp;</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="province-list"></div>
                    <div class="city-list" style="display:none"></div>
                    <div class="area-list" style="display:none"></div>
                </div>
            </div>
            <!--选择地区-e-->
        </div>
        <script src="__STATIC__/js/mobile-location.js"></script>
        <script>
            //选择地址回调
            var address_form = $('#address_form');
            function select_area_callback(province_name, city_name, district_name, province_id, city_id, district_id) {
                var area = province_name + ' ' + city_name + ' ' + district_name;
                $("#area").text(area);
                address_form.find("input[name='province']").val(getCookie('province_id'));
                address_form.find("input[name='city']").val(getCookie('city_id'));
                address_form.find("input[name='district']").val(getCookie('district_id'));
            }
        </script>
    </div>
</div>
<script type="text/javascript">
    var is_shipping_able = true,shop_list_data,cart2_form = $('#cart2_form');
    window.addEventListener('popstate', function () {
        panel();
    });
    $(document).ready(function () {
        var is_virtual = $("input[name='is_virtual']").val();
        if(is_virtual == 0){
            $('.no_shipping_div').hide();
            $('.shipping_div').show();
        }else{
            $('.no_shipping_div').show();
            $('.shipping_div').hide();
        }
        pay_pwd_view();
        get_address_list();
        ajax_order_price();
    });

    
    // 获取订单价格
    function ajax_order_price() {
        couponListHide();
        var address_id = cart2_form.find("input[name='address_id']").val();
        console.log(address_id);
        if(address_id == ''){
            get_address_list();
        }
        $.ajax({
            type: "POST",
            url: '/index.php?m=Mobile&c=Push&a=cart3',
            data: {address_id:address_id},
            dataType: "json",
            success: function (data) {
                is_shipping_able = true;
                if(data.hasOwnProperty('code') && data.code == 301){
                    is_shipping_able = false;
                    door_to_door_hide_or_show();
                }
                if (data.status != 1) {
                    layer.open({icon: 2, content: data.msg, time: 1, end:function(){
                        // 登录超时
                        if (data.status == -100) {
                            location.href = "{:U('Mobile/User/login')}";
                        }
                        $('.submit_price a').addClass("disable");
                    }});
                    return false;
                }else{
                    $('.submit_price a').removeClass("disable");
                    refresh_price(data);
                }
            }
        });
    }

    //各种弹窗返回上一步
    $(function () {
        //主页面返回上一步
        $(document).on('click', '#back', function () {
            var url = "/index.php?m=Mobile&c=Push&a=order_goods";
            window.location.href = url;
        });
        //地址弹窗返回上一步
        $(document).on('click', '#address_list_back,#invoice_list_back,#address_add_back,#shop_list_back,#shop_consignee_back,#map_back', function () {
            history.back(-1);
            panel();
        });
    });
    //点击地址
    $(function () {
        //点击地址
        $(document).on('click', '#addressDefault', function () {
            window.location.hash = "#addressList";
            get_address_list();
            panel();
        });
        //修改发票
        $(document).on('click', '#invoiceDefault', function () {
            window.location.hash = "#invoicelist";
            panel();
        });
        //选择地址
        $(document).on('click', '.select_address', function () {
            var address_id = $(this).data('address-id');
            var mobile = $(this).data('mobile');
            var consignee = $(this).data('consignee');
            var address_area = $(this).data('address-area');
            var address = $(this).data('address');
            var province_id = $(this).data('province-id');
            var city_id = $(this).data('city-id');
            var district_id = $(this).data('district-id');
            var longitude = $(this).data('longitude');
            var latitude = $(this).data('latitude');
            cart2_form.find("input[name='address_id']").val(address_id);
            $("#default_address_mobile").empty().html(mobile);
            $("#default_address_consignee").empty().html(consignee);
            $("#default_address_text").empty().html(address_area + ' '+ address);
            window.location.hash = "#";
            panel();
            get_shop_list(province_id, city_id, district_id, '', longitude, latitude);
          
        });
        //点击新建地址
        $(document).on('click', '#add_address', function () {
            address_form.find("input[name='address_id']").val('');
            address_form.find("input[name='consignee']").val('');
            address_form.find("input[name='address']").val('');
            address_form.find("input[name='mobile']").val('');
            address_form.find("input[name='province']").val('');
            address_form.find("input[name='city']").val('');
            address_form.find("input[name='district']").val('');
            $('#area').html('');
            window.location.hash = "#addressAdd";
            panel();
        });
        //添加地址
        $(document).on('click', '#address_form_confirm', function () {                   	       	
            $.ajax({
                type: "POST",
                url: '/index.php?m=Mobile&c=User&a=addressSave',
                data:  $("#address_form").serialize(),
                dataType: "json",
                beforeSend:function(){
    				var bgs =$("<div class='bg_time'><img src='__STATIC__/images/timg_zzjj.gif'></div>")
    				$(".dizhi-pop").append(bgs)    				
    			},
                success: function (data) {
                	$(".bg_time").remove()
                    if (data.status == 1) {
                        $("#address_add_back").trigger('click');
                        get_address_list(data.result.address_id); 
                    } else {                  	
                        var err_msg = data.msg;
                        $.each(data.result, function (index, item) {
                            err_msg = item;
                        });
                        layer.open({icon: 2, content: err_msg, time: 2});
                    }
                }
            });
        });

        //编辑地址弹窗事件
        $(document).on("click", '.address_item', function (e) {
            window.location.hash = "#addressAdd";
            panel();
            var select_address = $(this).parent().parent().find('.select_address');
            address_form.find("input[name='address_id']").val(select_address.data('address-id'));
            address_form.find("input[name='consignee']").val(select_address.data('consignee'));
            address_form.find("input[name='address']").val(select_address.data('address'));
            address_form.find("input[name='mobile']").val(select_address.data('mobile'));
            address_form.find("input[name='province']").val(select_address.data('province-id'));
            address_form.find("input[name='city']").val(select_address.data('city-id'));
            address_form.find("input[name='district']").val(select_address.data('district-id'));
            $('#area').html(select_address.data('address-area'));
        })
    });
    //单页面显示
    function panel(){
        var hash = window.location.hash;
        $('#wrapBody').children('div').hide();
        if(hash == ''){
            $('#pagePay').show();
        }else{
            $(hash).show();
        }
    }
    //获取自提点列表
    function get_shop_list(province_id, city_id, district_id, shop_address, longitude, latitude) {
        $.ajax({
            type: "POST",
            url: "{:U('Home/Api/shop')}",
            dataType: 'json',
            data: {
                province_id: province_id,
                city_id: city_id,
                district_id: district_id,
                shop_address: shop_address,
                longitude: longitude,
                latitude: latitude
            },
            success: function (data) {
                if(data.length > 0){
                    shop_list_data = data;
                    set_shop_list();
                }else{
                    shop_list_data = [];
                    if($('#door_to_door').hasClass('z-dispatching-cheng')){
                        $('#express_delivery').trigger('click');
                    }
                }
                door_to_door_hide_or_show();
            }
        });
    }
    //上门自提按钮显示
    function door_to_door_hide_or_show(){
        var door_to_door_div = $('#door_to_door_div');
        if(is_shipping_able == true && shop_list_data.length > 0){
            door_to_door_div.show();
        }else{
            door_to_door_div.hide();
        }
    }
    //自提点初始化
    function set_shop_list() {
        var shop_html = '';
        var near_show_html = '';
        for (var i = 0; i < shop_list_data.length; i++) {
            if(i == 0){
                near_show_html = '';
            }else{
                near_show_html = "style='display:none'";
            }
            shop_html += '<li class="p" data-shop-id="'+shop_list_data[i].shop_id+'" data-longitude="'+shop_list_data[i].longitude+'" data-latitude="'+shop_list_data[i].latitude+'"' +
                    ' data-shop-address="'+shop_list_data[i].area_list[0].name+shop_list_data[i].area_list[1].name+shop_list_data[i].area_list[2].name+ shop_list_data[i].shop_address +'"' +
                    ' data-phone="'+shop_list_data[i].phone+'" data-work-day="'+shop_list_data[i].work_day+'" ' +
                    'data-work-time="'+shop_list_data[i].work_time+'"> <div class="fl Package-radio-wrap"> <div class="Package-radio"> ' +
                    '<label class="Package-radio-label"></label> </div> </div> <div class="fl Package-radio-cont"> <div class="z-SelectPackage-title">' +
                    shop_list_data[i].shop_name + '</div> <div class="z-SelectPackage-nvg"><span>'+shop_list_data[i].shop_address+'</span></div> ' +
                    '<div class="z-SelectPackage-phon">电话:<em>' + shop_list_data[i].phone + '</em></div> </div> ' +
                    '<div class="fl Package-radio-Lately p"> <i class="Package-Lately  fl" '+near_show_html+'> 离我最近 </i> <div class="Package-distance-wrap fr">' +
                    ' <div class="Package-distance">' + shop_list_data[i].distance_text + '</div> <div class="p distance-icon-wrap"> <div class="Package-distance-icon fl"> ' +
                    '</div> <span class="Package-Location fl"></span> </div> </div> </div> </li>';
        }
        $("#shop_list").empty().append(shop_html);
        initShop();
    }
    //自提点初始化数据
    function initShopInfo() {
        var consignee = cart2_form.find("input[name='consignee']");
        var mobile = cart2_form.find("input[name='mobile']");
        if(consignee.val() == ''){
            var consignee_val = $('#default_address_consignee').html();
            consignee.val(consignee_val);
        }
        if(mobile.val() == ''){
            var mobile_val = $('#default_address_mobile').html();
            mobile.val(mobile_val);
        }
        $('#consignee_txt').html(consignee.val());
        $('#mobile_txt').html(mobile.val());
        $('#mobile').val(mobile.val());
        $('#consignee').val(consignee.val());
        var shop_item = $('.Package-radio-checked').parent().parent().parent();
        $('#shop_address').html(shop_item.find('.z-SelectPackage-title').html());
        if($('#express_delivery').hasClass('z-dispatching-cheng')){
            cart2_form.find("input[name='shop_id']").val('');
        }
    }
  
    //获取地址列表
    function get_address_list(select_address_id){
        var address_id = cart2_form.find("input[name='address_id']");
        $.ajax({
            type: "get",
            url: '/index.php?m=Mobile&c=User&a=ajaxAddressList',
            dataType: "json",
            success: function (data) {
                var address_list_html = '';
                for (var i = 0; i < data.length; i++) {
                    address_list_html += '<div class="jd_listaddless p "> <div class="maleri30"> <a class="select_address address_id_'+data[i].address_id+'" ' +
                            'data-address-id="'+data[i].address_id+'" data-mobile="'+ data[i].mobile +'" data-consignee="'+ data[i].consignee+'" ' +
                            'data-address-area="'+ data[i].address_area+'" data-address="'+ data[i].address+'" data-province-id="'+data[i].province+'"  ' +
                            'data-city-id="'+data[i].city+'" data-district-id="'+data[i].district+'" data-town-id="'+data[i].twon+'" data-longitude="'+data[i].longitude+'" ' +
                            'data-latitude="'+data[i].latitude+'"  > <div class="name fl"> <h1>'+data[i].consignee+'</h1> </div> <div class="numberaddress fl"> ' +
                            '<span class="number"><i class="number-dh">电话：</i>'+ data[i].mobile +'</span> <span class="similars">' + data[i].address_area + ' ' + data[i].address +'</span> ' +
                            '</div> </a> <div class="editdiv fl"> <a class="address_item"> <i class="eedit"></i> </a> </div> </div> </div>';
                }
                
                $("#address_list_html").empty().html(address_list_html);
                if(data.length == 0){
                    $("#add_address").trigger('click');
                }
                if(data.length > 0 && address_id.val() == ''){
                    $("#address_list_html").find('.select_address').eq(0).trigger('click');
                }
                if(select_address_id > 0){
                    $("#address_list_html").find('.address_id_'+select_address_id).trigger('click');
                }
            }
        });
    }
    function close_location(){
        var province_div = $('.province-list');
        var city_div = $('.city-list');
        var area_div = $('.area-list');
        if(area_div.is(":hidden") == false){
            area_div.hide();
            city_div.show();
            province_div.hide();
            return;
        }
        if(city_div.is(":hidden") == false){
            area_div.hide();
            city_div.hide();
            province_div.show();
            return;
        }
        if(province_div.is(":hidden") == false){
            area_div.hide();
            city_div.hide();
            $('.container').animate({width: '0', opacity: 'show'}, 'normal',function(){
                $('.container').hide();
            });
            undercover();
            $('.mask-filter-div').css('z-index','inherit');
            return;
        }
    }
    function location_address(e){
        $('.container').animate({width: '14.4rem', opacity: 'show'}, 'normal',function(){
            $('.container').show();
        });
        if(!$('.container').is(":hidden")){
            $('body').css('overflow','hidden')
            cover();
            $('.mask-filter-div').css('z-index','9999');
        }
    }
    //自提点
    $(function () {
        //选择快递配送
        $(document).on('click', '#express_delivery', function () {
            $(".dispatching-cont").removeClass("z-dispatching-cheng");
            $(this).addClass("z-dispatching-cheng");
            $(".dispatching-font1").show().siblings(".dispatching-font2").hide();
            $(".dispatching-Package").slideUp();
            cart2_form.find("input[name='shop_id']").val('');
           
        });
       
       
       
     
        $(document).on('click', '.Package-distance-wrap', function () {
            window.location.hash = "#map";
            panel();
            show_map();
        });
    })
    //积分余额密码
    $(function () {
        //选择使用积分和余额
        $(document).on('click', '#pay_points,#user_money', function () {
            pay_pwd_view();
          
        });
        //支付密码点击事件
        $(document).on('blur', '#pay_pwd', function () {
            var pay_pwd = md5($("input[name='auth_code']").val() + $.trim($('#pay_pwd').val()));
            $('input[name="pay_pwd"]').val(pay_pwd);
        })
    })
    //备注
    $(function () {
        //备注输入
        $(document).on('keyup', '#user_note', function () {
            $('input[name="user_note"]').val(this.value);
            var len = this.value.length;
            var limit = 50;
            if(len > limit){
                $(this).val($(this).val().substring(0,limit));
            }
            var num = limit - len;
            if(num <= 0){
                $("#zero").text(0);
            }else{
                $("#zero").text(num);
            }
        });
    })
    //支付密码是否显示
    function pay_pwd_view() {  
        var user_money = $('#user_money');
        var pay_points = $('#pay_points'); 
        if (user_money.is(':checked')) {
            $("input[name='user_money']").val(user_money.val());
        }else{
            $("input[name='user_money']").val('');
        }
        if (pay_points.is(':checked')) {
            $("input[name='pay_points']").val(pay_points.val());
        }else{
            $("input[name='pay_points']").val('');
        }
        if (user_money.is(':checked') || pay_points.is(':checked')) {
            $('#paypwd_view').show();
        } else {
            $('#paypwd_view').hide();
        }
    }
    //兑换优惠券
    function wield() {
        var couponCode = $('#couponCode').val();
        if (couponCode == '') {
            layer.open({icon: 1, content: "请输入兑换码！", time: 2});
            return ;
        }
        $.ajax({
            type: "POST",
            url: '/index.php?m=Home&c=Cart&a=cartCouponExchange',
            data: {coupon_code: couponCode},
            dataType: "json",
            success: function (data) {
                if (data.status != 1) {
                    layer.open({icon: 2, content: data.msg, time: 1, end:function(){
                        // 登录超时
                        if (data.status == -100) {
                            location.href = "{:U('Mobile/User/login')}";
                        }
                    }});
                } else {
                    layer.open({icon: 1, content: data.msg, time: 1, end:function(){
                        window.location.reload();
                    }});
                }
            }
        });
    }
   
   
  
    // 提交订单
    var ajax_return_status = 1; // 标识ajax 请求是否已经回来 可以进行下一次请求
    
    function submit_order() {
        var prop = $('#user_money').prop('checked');
        
        if(prop){
            var paypwd = $('#pay_pwd').val();
            if(!paypwd){
                showErrorMsg('请输入支付密码');
                return false;
            }
            
        }
        if ($('.submit_price a').hasClass("disable")) {
            return;
        }
        if (ajax_return_status == 0){
            return false;
        }
        ajax_return_status = 0;

        $.ajax({
            type: "POST",
            url: "{:U('Mobile/Cart/cart3')}",//+tab,
            data: cart2_form.serialize() + "&act=submit_order&pay_pwd="+paypwd,// 你的formid
            dataType: "json",
            success: function (data) {
                layer.closeAll();
                if (data.status != 1) {
                    showErrorMsg(data.msg);  //执行有误
                    // 登录超时
                    if (data.status == -100){
                        location.href = "{:U('Mobile/User/login')}";
                    }
                    ajax_return_status = 1; // 上一次ajax 已经返回, 可以进行下一次 ajax请求
                    return false;
                }
                $("#postFee").text(data.result.shipping_price); // 物流费
                if (data.result.coupon_price == null) {
                    $("#couponFee").text(0);// 优惠券
                } else {
                    $("#couponFee").text(data.result.coupon_price);// 优惠券
                }
                $("#balance").text(data.result.user_money);// 余额
                $("#pointsFee").text(data.result.integral_money);// 积分支付
                $("#payables").text(data.result.order_amount);// 应付
                $("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动
                showErrorMsg('订单提交成功，跳转支付页面!');
                location.href = "/index.php?m=Mobile&c=Cart&a=cart4&order_sn=" + data.result;
            }
        });
    }
    $(function () {
        get_invoice();

        $('.submits_de').click(function () {
            $('.mask-filter-div').hide();
            $('.losepay').hide();
        })

        //显示隐藏使用发票信息
        $('.invoiceclickin').click(function () {
            get_invoice();
            $('#invoice').toggle(300);
        })
    })

    function couponListHide(){
        var displays= $("#couponList").css("display");
        if(displays=="none"){
            $('.mask-filter-div').hide();
        }
    }
    //优惠券
    $(function () {
        $(document).on('click', '.coupon_click', function () {
            window.location.hash = "#couponList";
            panel();
            cover();
            $('.coupongg').show();
            $('html,body').addClass('ovfHiden');
            var coupon_length = "{$userCouponNum['usable_num'] |default = '0'}";
            if (coupon_length == 0) {
                $('.soldout_cp').show();
                $('.no_get_coupon').hide();
            } else {
                $('.no_get_coupon').show();
                $('.soldout_cp').hide();
            }
        })
    })
    //关闭优惠券弹窗
    function closer() {
        window.location.hash = "#";
        panel();
        undercover();
        $('.newchoosecar').hide();
        $('html,body').removeClass('ovfHiden');
    }
    //选择优惠券
    function checkCoupon(obj) {
        $(obj).toggleClass('checked').siblings('.cuptyp').removeClass('checked')
        if ($(obj).hasClass('checked')) {
            var conponname = $(obj).data('conponname');
            var couponid = $(obj).data('couponid');
            $('.counpn_name').text(conponname); //优惠券名称显示出来
            $("input[name^='coupon_id']").val(couponid);  //优惠券ID写到隐藏表单
        } else {
            $("input[name^='coupon_id']").val('');  //优惠券ID写到隐藏表单
            $('.counpn_name').text('未使用');
        }
        closer();
       
    }
</script>

<!--发票优化-->
<script type="text/javascript">
    //发票相关js
    $("#intype1").click(function(){
        $(".invoice_comdel").css("display","none");
        $('#wap_invoice_title').val("");
        $('#wap_taxpayer').val("");
    });
    $("#intype2").click(function(){
        var radioCont = $('input[name="radio_cont"]:checked').val();
        if(radioCont == '商品明细' || radioCont == '商品类别'){
            $(".invoice_comdel").css("display","block");
        }else{
            $(".invoice_comdel").css("display","none");
        }
    });
    $("#intype3,#intype4").click(function(){
        $(".invoice_tit").css("display","block");
        var radioTitle = $('input[name="radio_title"]:checked').val();
        var radioCont = $('input[name="radio_cont"]:checked').val();
        $("#invoice_desc").val(radioCont);
        if(radioTitle == "个人"){
            $(".invoice_comdel").css("display","none");
            $('#wap_invoice_title').val("");
            $('#wap_taxpayer').val("");
        }else{
            $(".invoice_comdel").css("display","block");
        }
    });
    $("#intype5").click(function(){
        var radioCont = $('input[name="radio_cont"]:checked').val();
        $("#invoice_desc").val(radioCont);
        $(".invoice_tit").css("display","none");
        $(".invoice_comdel").css("display","none");
        $('#wap_invoice_title').val("");
        $('#wap_taxpayer').val("");
    });
    //填写发票确认按钮
    $("#submit_invoice").click(function() {
        var radioTitle = $('input[name="radio_title"]:checked').val();
        var invoice_title = $("#invoice_title").val();
        var taxpayer = $("#taxpayer").val();
        var radioCont = $('input[name="radio_cont"]:checked').val();
        if (radioTitle=="单位" && radioCont!="不开发票"){
            if (invoice_title.length == 0) {
                layer.open({icon: 1, content: "发票抬头不能为空！", time: 2});
                return false;
            }
            if ((taxpayer.length == 15) || (taxpayer.length == 18) || (taxpayer.length == 20)) {
            } else {
                layer.open({icon: 1, content: "请输入正确的纳税人识别号！", time: 2});
                return;
            }
            var addressCode = taxpayer.substring(0, 6);
            // 校验地址码
            var check = checkAddressCode(addressCode);
            if (!check) {
                layer.open({icon: 1, content: "请输入正确的纳税人识别号！", time: 2});
                return;
            }
            // 校验组织机构代码
            var orgCode = taxpayer.substring(6, 9);
            check = orgcodevalidate(orgCode);
            if (!check) {
                layer.open({icon: 1, content: "请输入正确的纳税人识别号！", time: 2});
                return;
            }
            $('#wap_taxpayer').val(taxpayer);
            $('#wap_invoice_title').val(invoice_title);
        }else{
            $('#wap_taxpayer').val("");
            $('#wap_invoice_title').val("");
        }
        var str = "";
        if(radioCont!="不开发票"){
            if(radioTitle=="单位"){
                str = "纸质（"+invoice_title+"-"+radioCont+"）";
            }else {
                str = "纸质（个人-"+radioCont+"）";
            }
        }else{
            str = "不开发票";
        }
        $(".invoice_title").html(str);
        save_invoice();
        window.location.hash = "#";
    });
    //获取发票信息
    function get_invoice() {
        var str = "";
        $.get("{:U('Cart/invoice')}", function (json) {

            var data = JSON.stringify(json);

            if (data.status > 0) {
                if (data.result.invoice_title != "") {
                    $('#wap_invoice_title').val(data.result.invoice_title);
                    $('#wap_taxpayer').val(data.result.taxpayer);
                    $('#invoice_title').val(data.result.invoice_title);
                    $("#invoice_desc").val(data.result.invoice_desc);
                    $("#taxpayer").val(data.result.taxpayer);
                    str = "纸质（" + data.result.invoice_title + "-"+data.result.invoice_desc+"）";
                }
                if (data.result.invoice_title == "个人" && data.result.invoice_desc != "不开发票") {
                    $('#wap_invoice_title').val("个人");
                    $('#wap_taxpayer').val("");
                    $('#invoice_title').val("");
                    $("#taxpayer").val("");
                    $(".invoice_title").html("纸质（个人-"+data.result.invoice_desc+"）");
                    str = "纸质（个人-"+data.result.invoice_desc+"）";
                }
                if (data.result.invoice_desc == "不开发票") {
                    $(".invoice_tit").css("display","none");
                    $(".invoice_comdel").css("display","none");
                    $("#intype5").attr("checked", "checked");
                    $('#wap_invoice_title').val("");
                    $('#wap_taxpayer').val("");
                    $('#invoice_title').val("");
                    $("#invoice_desc").val(data.result.invoice_desc);
                    $("#taxpayer").val("");
                    str = "不开发票";
                }
                //加载之前发票信息
                $(".invoice_title").html(str);
                if(data.result.invoice_title == "单位" && data.result.taxpayer == ""){
                    $("#intype1").attr("checked", "checked");
                }
                if(data.result.taxpayer　!= ""){
                    $(".invoice_comdel").css("display","block");
                    $("#intype2").attr("checked", "checked");
                }
                if(data.result.invoice_desc　== "商品明细") {
                    $("#intype3").attr("checked", "checked");
                }
                if(data.result.invoice_desc　== "商品类别") {
                    $("#intype4").attr("checked", "checked");
                }
                $(".invoice_title").html(str);
            } else {
                $("#intype1").attr("checked", "checked");
                $("#intype3").attr("checked", "checked");
            }
        });
    }
    //修改发票信息
    function save_invoice() {
        var invoice_desc = $('#invoice_desc').val();
        if(invoice_desc != "不开发票") {
            var invoice_title = $('input[name="radio_title"]:checked').val();
            if (invoice_title == "单位") {
                var invoice_title = $('#wap_invoice_title').val();
                var taxpayer = $('#wap_taxpayer').val();
            }
        }
        var data = {invoice_title: invoice_title, taxpayer: taxpayer, invoice_desc: invoice_desc};
        $.post("{:U('Cart/save_invoice')}", data, function (json) {
            var data = eval("(" + json + ")");
            $("#invoice").hide();
        });
    }
    $(document).on('keyup', '#mobile_check', function() {
        $('input[name="mobile"]').val(this.value);
    })

    
</script>
</body>
</html>
