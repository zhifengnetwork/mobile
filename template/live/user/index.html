<!DOCTYPE html>
<html>
<head>
    <title>用户端-直播间</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="__STATIC__/live/vendor/bootstrap.min.css">
    <script src="__STATIC__/live/js/AgoraRTCSDK-2.6.1.js"></script>
    <script src="__STATIC__/live/vendor/jquery.js"></script>
    <script src="__STATIC__/live/vendor/rem.js"></script>

    <link href="__STATIC__/chat/css/bootstrap.min.css" rel="stylesheet">
    <link href="__STATIC__/chat/css/style.css" rel="stylesheet">
    <script type="text/javascript" src="__PUBLIC__/js/mobile-util.js"></script>
    <script src="__STATIC__/live/static/js/public/rem.js" type="text/javascript" charset="utf-8"></script>

    <link rel="stylesheet" href="__STATIC__/live/static/css/public/swiper.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/live/static/css/public/base.css" />
    <link rel="stylesheet" href="__STATIC__/live/static/css/play/viewer_room.css?v=201906121840">
    <link href="__STATIC__/chat/css/base.css" rel="stylesheet">

    <style type="text/css">
        .barrage-scroll .barrage-list .dm-item{
            font-size: .3rem;
            color: black;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: .2rem;
        }
    </style>
<style>
    .sendBtn{
        width: 5rem;
        height: .6rem;
        line-height: .6rem;
        font-size: .3rem;
        background-color: #ef67c9;
        display: block;
        text-align: center;
        /* color: #ffffff; */
        border-radius: .12rem;
        margin: .3rem auto;
    }
    .enveloper-popup{
        width: 100%;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        display: none;
        z-index:99999;
    }
    /* 未拆状态  */
    .enveloper-popup .undemolished{
        width: 4.44rem;
        height: 4.44rem;
        color: #ffffff;
        text-align: center;
        background: url(/public/images/red-enveloper-bg.png) no-repeat;
        background-size: 100%;
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 3;
        transform: translate(-50%,-50%);
        display: none;
    }
    .enveloper-popup .undemolished .popup-header{
        height: 1.6rem;
        line-height: 1.6rem;
        text-align: center;
        font-size: .36rem;
    }
    .enveloper-popup .undemolished .popup-body{
        margin: .66rem auto .9rem;
    }
    .enveloper-popup .undemolished .popup-body p{
        font-size: .36rem;
    }
    .enveloper-popup .undemolished .popup-footer .open-btn{
        width: 3.24rem;
        height: 1.04rem;
        line-height: 1.04rem;
        text-align: center;
        font-size: .3rem;
        color: #ff008a;
        margin: 0 auto;
        background: url(/public/images/enveloper-send-bg.png) no-repeat;
        background-size: 100%;
    }
    .enveloper-popup .undemolished .popup-footer .close-btn{
        width:.99rem;
        height: .99rem;
        background: url(/public/images/enveloper-close-btn.png) no-repeat;
        background-size: 100%;
        margin: -.2rem auto 0;
    }

    /* 拆开状态 */
    .open-status{
        width: 4.44rem;
        height: 5.21rem;
        /* color: #ffffff; */
        text-align: center;
        background: url(/public/images/red-enveloper-open-bg.png) no-repeat;
        background-size: 100%;
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 3;
        transform: translate(-50%,-50%);
        display: none;
        z-index:99999;
    }
    .open-status .popup-header{
        height: 1rem;
        line-height: 1rem;
        margin-bottom: 1rem;
    }
    .open-status .popup-body{
        margin-bottom: 1.8rem;
    }
    .open-status .popup-body h3{
        font-size: .4rem;
        margin-bottom: .34rem;
    }
    .open-status .popup-body p{
        font-size: .28rem;
    }
    .open-status .popup-body p .amount-num{
        font-size: .28rem;
        color: #fff600;
    }
    .open-status .close-btn{
        width:.99rem;
        height: .99rem;
        background: url(/public/images/enveloper-close-btn.png) no-repeat;
        background-size: 100%;
        margin:0 auto;
    }
</style>
</head>

<body onload="connect();">
    <div class="enveloper-popup">
        <!-- 未拆状态 -->
        <!-- <div class="undemolished">
            <div class="popup-header">
                <h3>主播红包</h3>
            </div>
            <div class="popup-body">
                <p>红包</p>
            </div>
            <div class="popup-footer">
                <div class="open-btn">立即拆开</div>
                <div class="close-btn"></div>
            </div>
        </div> -->
    
        <!-- 拆开状态 -->
        <!-- <div class="open-status">
            <div class="popup-header">
                <h3>红包</h3>
            </div>
            <div class="popup-body">
                <h3>获得红包</h3>
                <p><span class="amount-num">8.88</span> 元</p>
            </div>
            <div class="popup-footer">
                <div class="close-btn"></div>
            </div>
        </div> -->
    
    </div>
    <div class="wrapper">
        <input type="text" id="room_id" value="{$room_id}" style="display: none;">
        <input type="text" id="users_id" value="{$users_id}" style="display: none;">
        <div id="div_device" class="panel panel-default" style="display: none">
            <div class="select">
                <label for="audioSource">Audio source: </label><select id="audioSource"></select>
            </div>
            <div class="select">
                <label for="videoSource">Video source: </label><select id="videoSource"></select>
            </div>
        </div>
        <input type="text" id="room_id" value="{$room_id}" style="display: none;">
        <input type="text" id="users_id" value="{$users_id}" style="display: none;">
        <div id="div_join" class="panel panel-default" style="display: none">
            <div class="panel-body">
                App ID: <input id="appId" type="text" value="4c2954a8e1524f5ea15dc5ae14232042" size="36" />
                Channel: <input id="channel" type="text" value="<?php echo $room_id; ?>" />
                Host: <input id="video" type="checkbox"></input>
                <button id="join" class="btn btn-primary" onclick="join()">Join</button>
                <button id="leave" class="btn btn-primary" onclick="leave()">Leave</button>
                <button id="publish" class="btn btn-primary" onclick="publish()">Publish</button>
                <button id="unpublish" class="btn btn-primary" onclick="unpublish()">Unpublish</button>
            </div>
        </div>
    
        <!-- 摄像头 -->
        <div id="video_live" style="margin:0 auto;width: 100%;height: 100vh;" >
            <div id="agora_local" style="width: 7.5rem;height:100vh;display:inline-block;"></div>
        </div>
    
        <!-- 直播间内容 -->
        <div class="live-room">
            <div class="topBar">
                    <div class="viewer-info">
                        <img class="avatar" src="{$zhubo_head_pic}" />
                        <span class="name">{$zhubo_user_name}</span>
                </div>
                <div class="liveId">
                    <span class="shop-name" onclick="shop_url();">DC商城</span>
                    <!--<span class="id">ID:123456</span>-->
                </div>
                <div class="closeBtn"></div>
            </div>
    
            <div class="anchor-part">
                <span class="viewer" id="user_count"><i class="icon"></i>1人</span>
                <span class="follow" id="user_top"><i class="icon" onclick="live_top('<?php echo $user_id; ?>','<?php echo $room_id; ?>')"></i><?php echo $room['top_amount']; ?>人</span>
            </div>
    
            <!-- 聊天窗口 -->
            <div class="chat-wrap">
    
                <!-- 礼物 -->
                <div class="showGift-wrap"></div>
    
                <!-- 弹幕滚动 -->
                <div class="barrage-scroll">
                    <ul class="barrage-list" id="dialog-list">
                    </ul>
                </div>
    
                <!-- 商品链接 -->
                <div class="goods-links"></div>
    
                    <!-- 发送弹幕 -->
                <div class="chat-operate" >
                    <div class="msg-input">
                        <span>说点什么...</span>
                    </div>
                    <div class="send-redPacket"></div>
                    <div class="cart" onclick="cart_url('<?php echo $user_id; ?>','<?php echo $room_id; ?>');"></div>
                    <div class="share" onclick = "share_url()"></div>
                    <div class="gift"></div>
                </div>
    
                <!-- 输入框 -->
                <div class="send-group">
                    <div class="textarea" contenteditable="true" placeholder ="说点什么" id="textarea"></div>
                    <div class="send-btn" onclick="onSubmit()">发送</div>
                </div>
    
            </div>
    
        </div>
    
        <!-- 遮罩层 -->
        <div class="mask">
            <!-- 红包弹窗 -->
            <div class="popup redPacket-popup">
                <div class="popup-header">
                    <h3>手气红包</h3>
                </div>
                <div class="popup-body">
                    <div class="group-wrap">
                        <span class="title">单个金额</span>
                        <span class="right">
                            <input type="text" id="redmoney" placeholder="0.00">
                        元</span>
                    </div>
                </div>
                <div class="popup-footer">
                    <span class="send-btn" onclick="send_red('<?php echo $user_id; ?>','<?php echo $room_id; ?>')">发红包</span>
                </div>
                <div class="close-btn"></div>
            </div>
        </div>
    
            <!-- 赠送礼物 -->
            <div class="gift-wrap">
            <div class="thead"><h3>赠送礼物</h3><span class="close"></span></div>
            <div class="tbody">
                <div class="swiper-container gift-container">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <input type="hidden" id="item_gift_id" name="item_gift_id" value="0" />
                            <?php if(!empty($giftList)){ ?>
                                <?php foreach($giftList as $k=>$v){ ?>
                                    <div class="gift-item" id="<?php echo $v['id']; ?>"><img src="<?php echo $url; ?><?php echo $v['image']; ?>" /></div>
                                <?php } ?>
                            <?php } ?>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>                    
    
            </div>
            <div class="sendBtn" onclick="send_gift('<?php echo $user_id; ?>','<?php echo $room_id; ?>')">发送</div>
        </div>
    
    </div>

    <!---  之前内容  --->
    <div class="container" style="display: none">
    <div class="row clearfix">
    <div class="col-md-1 column">
    </div>
    <div class="col-md-6 column">
    <div class="thumbnail">
    <div class="caption" id="dialog"></div>
    </div>
    <form>
    <select style="margin-bottom:8px" id="client_list" style="display: none">
    <option value="all">所有人</option>
    </select>
    <!--<textarea class="textarea thumbnail"></textarea>-->
    <!--<div class="say-btn"><input type="button" class="btn btn-default" value="发表" /></div>-->
    </form>
    <div>
    </div>
    </div>
    <div class="col-md-3 column">
    <div class="thumbnail">
    <div class="caption" id="userlist"></div>
    </div>
    
    </div>
    </div>
    </div>

    <div class="share-shade" style="position: fixed; top: 0; z-index: 999; display:none; height:100%; width:100%; overflow: hidden;">
        <img width="100%" style="height: 100%" src='__PUBLIC__/images/open_brower_shadow.png' />
    </div>

    <script type="text/javascript" src="__STATIC__/chat/js/swfobject.js"></script>
    <script type="text/javascript" src="__STATIC__/chat/js/web_socket.js"></script>
    <script type="text/javascript" src="__STATIC__/chat/js/jquery.min.js"></script>
    <script src="__STATIC__/live/static/js/public/jquery-3.3.1.min.js"></script>
    <script src="__STATIC__/live/static/js/public/swiper.js"></script>



<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
 //如果微信分销配置正常, 商品详情分享内容中的"图标"不显示, 则检查域名否配置了https, 如果配置了https,分享图片地址也要https开头
 var httpPrefix  = "http://{$Think.server.SERVER_NAME}";
 var ShareLink   = httpPrefix+"/index.php?m=live&c=user&a=index&room_id={$room_id}"; //默认分享链接
 var ShareImgUrl = httpPrefix+"{$tpshop_config['shop_info_store_logo']}"; //分享图标
 var ShareTitle  = "{$zhubo_user_name}"+"的直播间"; //分享标题
 var ShareDesc   = "{$tpshop_config['shop_info_store_desc']}"; //分享描述
 //是否微信打开
 function is_weixn() {
        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == "micromessenger") {
            return true;
        }
        return false;
}

$(function() {
    //判断是否是微信环境
	if(is_weixn()){
		$.ajax({
			type : "POST",
			url:"/index.php?m=Mobile&c=Index&a=ajaxGetWxConfig&t="+Math.random(),
			data:{'askUrl':encodeURIComponent(location.href.split('#')[0])},		
			dataType:'JSON',
            async:false,
			success: function(res)
			{
				//微信配置
				wx.config({
				    debug: false, 
				    appId: res.appId,
				    timestamp: res.timestamp, 
				    nonceStr: res.nonceStr, 
				    signature: res.signature,
				    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage','onMenuShareQQ','onMenuShareQZone','hideOptionMenu'] // 功能列表，我们要使用JS-SDK的什么功能
				});
                console.log(123123);
                console.log(res);
			},
			error:function(res){
				console.log("wx.config error:");
				console.log(res);
				return false;
			}
		}); 
	}

    	// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在 页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready 函数中。
		wx.ready(function(){
		    // 获取"分享到朋友圈"按钮点击状态及自定义分享内容接口
		    wx.onMenuShareTimeline({
		        title: ShareTitle, // 分享标题
		        link:ShareLink,
		        desc: ShareDesc,
		        imgUrl:ShareImgUrl // 分享图标
		    });

		    // 获取"分享给朋友"按钮点击状态及自定义分享内容接口
		    wx.onMenuShareAppMessage({
		        title: ShareTitle, // 分享标题
		        desc: ShareDesc, // 分享描述
		        link:ShareLink,
		        imgUrl:ShareImgUrl // 分享图标
		    });
			// 分享到QQ
			wx.onMenuShareQQ({
		        title: ShareTitle, // 分享标题
		        desc: ShareDesc, // 分享描述
		        link:ShareLink,
		        imgUrl:ShareImgUrl // 分享图标
			});	
			// 分享到QQ空间
			wx.onMenuShareQZone({
		        title: ShareTitle, // 分享标题
		        desc: ShareDesc, // 分享描述
		        link:ShareLink,
		        imgUrl:ShareImgUrl // 分享图标
			});
		  	
		});

        
     
});
</script>



    <script>
        $(function(){
            //礼物滑动
            var swiper = new Swiper('.gift-container', {
                loop: true,
                pagination: '.swiper-pagination',
                paginationClickable: true,
                autoplayDisableOnInteraction: false
            });

  
    
            // 主播发红包
            $('.send-redPacket').click(function(){
                $(".mask,.redPacket-popup").show();
            });
    
            // 关闭发红包
            $(".close-btn").click(function(){
                $(".mask,.redPacket-popup").hide()
            });
    
            // 礼物显示
            $(".gift").click(function(){
                $(".gift-wrap").css("visibility","visible");
                $(".gift-wrap").show();
            })
    
            // 礼物隐藏
            $(".gift-wrap .close").click(function(){
                $(".gift-wrap").css("visibility","hidden");
            })

            // 礼物选中
            $(".gift-wrap .gift-item").click(function(){
                $("#item_gift_id").val(this.id);
                var giftVal = $(this).html();
                $(this).parents().siblings().children().removeClass("active");
                $(this).siblings().removeClass("active");
                $(this).addClass("active");

            })

            // 取消冒泡
            $(".gift-wrap,.gift").click(function(){
                var e = window.event || event;
                if(e.stopPropagation){
                    e.stopPropagation();
                }else{
                    e.cancelBubble = true;
                }
            })
    
            //点击输入框
            $(".msg-input").click(function(){
                var e = window.event || event;
                if(e.stopPropagation){
                    e.stopPropagation();
                }else{
                    e.cancelBubble = true;
                }
                $(".chat-operate").hide();
                $(".goods-links").hide();
                $(".send-group").css("visibility","visible");
                // 点击发送按钮获取焦点
                $('.textarea').focus();
            })
    
            //改变发送按钮样式
            $('.send-group .textarea').keyup(function(){
                if($(this).html()!=''){
                    $('.send-group .send-btn').css('opacity','1')
                }else{
                    $('.send-group .send-btn').css('opacity','.5')
                }
            })
    
            // 发送消息
            $('.send-group .send-btn').click(function(){

            })
    
    
            if($(".send-group").css("visibility") == 'visibility'){
                return false;
            }else{
                $(".chat-operate").show();
                $(".goods-links").show();
            }
    
            // 点击空白处关闭
            document.onclick = function(){
                $(".send-group").css("visibility","hidden");
                $(".gift-wrap").css("visibility","hidden");
                $(".chat-operate").show();
                $(".goods-links").show();
            };


            // $(".gift-item").animate({ 
            //     left: "0",
            // }, 500 );
            $(".showGift-wrap .gift-item").last().hide();
            $(".showGift-wrap .gift-item").first().fadeOut(2000);
            $(".showGift-wrap .gift-item").last().fadeIn(2000);


         
    
        })
    </script>

<script>
    $(function(){
        // 调用摄像头
        join();

    })
</script>
    <script>
        //Dc商城跳转
        function shop_url(){
            location.href="{:U('mobile/index/index');}";
        }

                   //分享直播间
      function share_url(){
         
        is_weixn() && $('.share-shade').show();
      }

      $('.share-shade').on('touchend', function() {
           $('.share-shade').hide();
     });

    

        //点赞
        function live_top(user_id,room_id){
            $.ajax({
                type: "POST",
                data:{user_id:user_id,room_id:room_id},
                async:false,
                url: "/Live/user/like",
                success: function(data){
                    if(data.status==200){
                        var content = data.data;
                        var amount = content.count;
                        $("#user_top").html('<i class="icon" onclick="live_top('+user_id+','+room_id+');"></i>'+amount+"人");
                    }else{
                        alert(data.msg);
                    }
                }
            })
        }

        //跳转到购物车
        function cart_url(){
            location.href="{:U('mobile/Cart/index');}";
        }

      

        function send_red(user_id,room_id){
            var redmoney = $("#redmoney").val();
            var to_client_id = $("#client_list option:selected").attr("value");
            var to_client_name = $("#client_list option:selected").text();
            var user_level = '<?php echo $level; ?>';

            $.ajax({
                type: "POST",
                data:{user_id:user_id,room_id:room_id,money:redmoney},
                async:false,
                url: "/Live/user/sendRedPacket",
                success: function(data){
                    if(data.status==200){
                        var content = data.data;
                        var to_client_id = content.to_client_id;
                        var to_client_name = content.to_client_name;
                        var content = content.content;
                        ws.send('{"type":"say","user_level":"'+user_level+'","to_client_id":"'+to_client_id+'","to_client_name":"'+to_client_name+'","content":"'+content+'"}');
                        $(".mask,.redPacket-popup").hide();
                    }else{
                        alert(data.msg);
                    }
                }
            })
        }

        //发礼物
        function send_gift(user_id,room_id){
            //待修改礼物ID   add by zgp
            var gift_id = $("#item_gift_id").val();
            var to_client_id = $("#client_list option:selected").attr("value");
            var to_client_name = $("#client_list option:selected").text();
            var user_level = '<?php echo $level; ?>';

            $.ajax({
                type: "POST",
                data:{user_id:user_id,room_id:room_id,gift_id:gift_id},
                async:false,
                url: "/Live/user/sendGift",
                success: function(data){
                    if(data.status==200){
                        var content = data.data;
                        var gift_id_return = content.gift_id;
                        var to_client_id = content.to_client_id;
                        var to_client_name = content.to_client_name;
                        var content = content.content;
                        //消息聊天
                        ws.send('{"type":"say","user_level":"'+user_level+'","to_client_id":"'+to_client_id+'","to_client_name":"'+to_client_name+'","content":"'+content+'"}');
                        //礼物显示
                        ws.send('{"type":"gift","gift_id":"'+gift_id_return+'","to_client_id":"'+to_client_id+'","to_client_name":"'+to_client_name+'","content":"'+content+'"}');
                        $(".gift-wrap").hide();

                    }else{
                        alert(data.msg);
                    }
                }
            })
        }
    </script>

<script language="javascript">

    if(!AgoraRTC.checkSystemRequirements()) {
//        alert("Your browser does not support WebRTC!");
    }

    /* select Log type */
    // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);
    // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);
    // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.WARNING);
    // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.INFO);
    // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.DEBUG);

    /* simulated data to proof setLogLevel() */
    AgoraRTC.Logger.error('this is error');
    AgoraRTC.Logger.warning('this is warning');
    AgoraRTC.Logger.info('this is info');
    AgoraRTC.Logger.debug('this is debug');

    var client, localStream, camera, microphone;

    var audioSelect = document.querySelector('select#audioSource');
    var videoSelect = document.querySelector('select#videoSource');

    function join() {
        document.getElementById("join").disabled = true;
        document.getElementById("video").disabled = true;
        var channel_key = null;

        var channel_key=null;
        $.ajax({
            type: "POST",
            data:{appId:appId.value,channel:'<?php echo $room_id; ?>'},
            async:false,
            url: "/Live/user/RtmTokenBuilderSample",
            success: function(data){
                channel_key = data;
            }
        })

        console.log(channel_key);
        console.log("Init AgoraRTC client with App ID: " + appId.value);
        client = AgoraRTC.createClient({mode: 'live'});
        client.init(appId.value, function () {
            console.log("AgoraRTC client initialized");

            client.join(channel_key, '<?php echo $room_id; ?>', null, function (uid) {
                console.log("用户 " + uid + " 来到直播间 <?php echo $room_id; ?>" );
            }, function (err) {
                console.log("加入直播间失败")
            });

            client.on('stream-added', function (evt) {
                // 主播发布视频时会触发 stream-added 事件
                var stream = evt.stream;
                // 访客订阅 stream 流
                client.subscribe(stream, function (err) {
                    console.log("视频流订阅失败", err);
                });
            });

            client.on('stream-subscribed', function (evt) {
                // 主播端视频流订阅成功后触发 stram-subscribed 事件
                var stream = evt.stream;
                // 按指定元素 ID 播放视频流
                stream.play('agora_local');
            });


            client.on('stream-removed', function (evt) {
                // 主播端执行 unpublish 时会触发该事件
                var stream = evt.stream;
                // 停止视频播放
                stream.stop();
            });

            client.on('peer-leave', function (evt) {
                // 主播端执行 leave 下播操作时会触发该事件
                var stream = evt.stream;
                if (stream) {
                    // 停止视频流播放
                    stream.stop();
                }
            });

        }, function (err) {
            console.log("AgoraRTC client init failed", err);
        });




    }

</script>


<!--聊天室-->
<script type="text/javascript">
    if (typeof console == "undefined") {    this.console = { log: function (msg) {  } };}
    // 如果浏览器不支持websocket，会使用这个flash自动模拟websocket协议，此过程对开发者透明
    WEB_SOCKET_SWF_LOCATION = "__STATIC__/chat/swf/WebSocketMain.swf";
    // 开启flash的websocket debug
    WEB_SOCKET_DEBUG = true;

    var ws, name, client_list={};

    // 连接服务端
    function connect() {
        // 创建websocket
        var server_name = '<?php echo $server_name; ?>';
        ws = new WebSocket("ws://"+server_name+":7373");
        // 当socket连接打开时，输入用户名
        ws.onopen = onopen;
        // 当有消息时根据消息类型显示不同信息
        ws.onmessage = onmessage;
        ws.onclose = function() {
            console.log("连接关闭，定时重连");
            connect();
        };
        ws.onerror = function() {
            console.log("出现错误");
        };
    }

    // 连接建立时发送登录信息
    function onopen()
    {
        name = "{$user_name}";
        // 登录
        var login_data = '{"type":"login","client_name":"'+name.replace(/"/g, '\\"')+'","room_id":"<?php echo isset($room_id) ? $room_id : 1?>"}';
        console.log("websocket握手成功，发送登录数据:"+login_data);
        ws.send(login_data);
    }

    // 服务端发来消息时
    function onmessage(e)
    {
        console.log(e.data);
        var data = eval("("+e.data+")");
        switch(data['type']){
            // 服务端ping客户端
            case 'ping':
                ws.send('{"type":"pong"}');
                break;;
            // 登录 更新用户列表
            case 'login':
                say(data['client_id'], data['client_name'],  ' 加入了直播间', data['time'],'<?php echo $level; ?>');
                if(data['client_list'])
                {
                    client_list = data['client_list'];
                }
                else
                {
                    client_list[data['client_id']] = data['client_name'];
                }
                flush_client_list();
                console.log(data['client_name']+"登录成功");
                break;
            // 发言
            case 'say':
                say(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['user_level']);
                console.log(data['from_client_name']+"说："+data['content']);
                break;
            // 用户退出 更新用户列表
            case 'logout':
                //{"type":"logout","client_id":xxx,"time":"xxx"}
                say(data['from_client_id'], data['from_client_name'], data['from_client_name']+' 退出了', data['time'],data['user_level']);
                delete client_list[data['from_client_id']];
                flush_client_list();
                break;
            case 'redpacket':
                redpacket(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['user_level']);
                console.log(data['from_client_name']+"说："+data['content']);
                break;
            case 'gift':
                gift(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['gift_id'],data['user_level']);
                console.log(data['from_client_name']+"说："+data['content']);
                break;
            case 'goods':
                goods_url(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['goods_url']);
                console.log(data['from_client_name']+"说："+data['content']);
                break;
            //直播发红包
            case 'red_anchor':
                red_anchor(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['user_level']);
                console.log(data['from_client_name']+"说："+data['content']);
                break;
            //抢红包
            case 'red_receive':
                red_receive(data['from_client_id'], data['from_client_name'], data['content'], data['money'], data['time']);
                // console.log(data['from_client_name']+"说："+data['content']);
                say(data['from_client_id'], data['from_client_name'], data['content'], data['time'],data['user_level']);
                break;
        }
    }

    // 提交对话
    function onSubmit() {

        var input = $('#textarea').html();
        var to_client_id = $("#client_list option:selected").attr("value");
        var to_client_name = $("#client_list option:selected").text();
        var user_level = '<?php echo $level; ?>';

        $('.send-group .textarea').html('');
        ws.send('{"type":"say","user_level":"'+user_level+'","to_client_id":"'+to_client_id+'","to_client_name":"'+to_client_name+'","content":"'+input.replace(/"/g, '\\"').replace(/\n/g,'\\n').replace(/\r/g, '\\r')+'"}');
    }

    // 刷新用户列表框
    function flush_client_list(){
        var userlist_window = $("#userlist");
        var client_list_slelect = $("#client_list");
        userlist_window.empty();
        client_list_slelect.empty();
        userlist_window.append('<h4>在线用户</h4><ul>');
        client_list_slelect.append('<option value="all" id="cli_all">所有人</option>');
        var count = 0;
        for(var p in client_list){
            userlist_window.append('<li id="'+p+'">'+client_list[p]+'</li>');
            client_list_slelect.append('<option value="'+p+'">'+client_list[p]+'</option>');
            ++count;
        }
        $("#client_list").val(select_client_id);
        userlist_window.append('</ul>');
        $("#user_count").html('<i class="icon"></i>'+count+"人");

        //刷新点赞人数
        var user_id = '<?php echo $user_id; ?>';
        var room_id = '<?php echo $room_id; ?>';
        $.ajax({
            type: "POST",
            data:{user_id:user_id,room_id:room_id},
            async:false,
            url: "/Live/user/userTopAmount",
            success: function(data){
                if(data.status==200){
                    var content = data.data;
                    var amount = content.count;
                    if(amount == 0){
                        amount = 1;
                    }
                    $("#user_top").html('<i class="icon" onclick="live_top('+user_id+','+room_id+');"></i>'+amount+"人");
                }
            }
        })

    }

    // 发言
    function say(from_client_id, from_client_name, content, time,user_level){
        var str = '';
        str += '<li class="dm-item">';
        str +='<span class="level level-'+user_level+'"></span>';
        str +=' <span class="viewer-name">'+from_client_name+'：</span>';
        str +='<span class="barrage-con">'+content+'</span>';
        str +='</li>';


        $("#dialog-list").append(str);
        // 点击发送按钮获取焦点
        $('.textarea').focus();
        $('.send-group .send-btn').css('opacity','.5');
        // 滚动条到底部
        $('.barrage-scroll').animate({
            scrollTop: $('.barrage-scroll').height()
        }, 100);
    }

    //发红包
    function redpacket(from_client_id, from_client_name, content, time,user_level){
        console.log(content);
        var str = '';
        str += '<li class="dm-item">';
        str +='<span class="level level-'+user_level+'"></span>';
        str +=' <span class="viewer-name">'+from_client_name+'：</span>';
        str +='<span class="barrage-con">'+content+'</span>';
        str +='</li>';
        $("#dialog-list").append(str);

        // 点击发送按钮获取焦点
        $('.textarea').focus();
        $('.send-group .send-btn').css('opacity','.5');
        // 滚动条到底部
        $('.barrage-scroll').animate({
            scrollTop: $('.barrage-scroll').height()
        }, 100);
    }

    //发礼物
    function gift(from_client_id, from_client_name, content, time,gift_id){
        console.log(content);
        $(".showGift-wrap .gift-item").remove();
        var str = '';
        str += '<div class="gift-item">';
        str += '<span class="gift-icon"><img src="__STATIC__/live/static/images/play/gift-icon-'+gift_id+'.png" /></span>';
        str += '<span class="gift-count">x1</span>';
        str += '<span class="viewer-name">'+from_client_name+'</span>';
        str += '</div>';

        $(".showGift-wrap").append(str);
        $(".showGift-wrap .gift-item").last().hide();
        $(".showGift-wrap .gift-item").last().fadeIn(2000);


        // 点击发送按钮获取焦点
        $('.textarea').focus();
        $('.send-group .send-btn').css('opacity','.5');
        // 滚动条到底部
        $('.barrage-scroll').animate({
            scrollTop: $('.barrage-scroll').height()
        }, 100);
    }

    //发红包
    function red_anchor(from_client_id, from_client_name, content, m_id, time){
        console.log(content);
        var str = '';
        str +='<div class="undemolished">';
        str +='<div class="popup-header">';
        str +='<h3 style="margin-top: 23px;">主播红包</h3>';
        str +='</div>';
        str +='<div class="popup-body">';
        str +='<p>红包</p>';
        str +='</div>';
        str +='<div class="popup-footer">';
        str +='<div class="open-btn" onclick="testa('+m_id+');">立即拆开</div>';
        str +='<div class="close-btn" onclick="closeRed();"></div>';
        str +='</div>';
        str +='</div>';
        $(".enveloper-popup").append(str);
        $(".enveloper-popup").show();
        $(".enveloper-popup .undemolished").last().hide();
        $(".enveloper-popup .undemolished").last().fadeIn(2000);
    }
    //抢包
    function testa(m_id){
        var room_id = document.getElementById('room_id').value;
        var users_id = document.getElementById('users_id').value;
        var to_client_id = $("#client_list option:selected").attr("value");
        var to_client_name = $("#client_list option:selected").text();
        var user_level = '<?php echo $level; ?>';
        
        $.ajax({
            type: 'post',
            async:false,
            url: "{:U('live/index/click_red_packet')}", //请求的服务端地址
            data: {room_id: room_id,users_id: users_id,m_id: m_id},    
            dataType: 'json',
            success: function (data) {
                if(data.status==200){
                    var content = data.data;
                    var to_client_id = content.to_client_id;
                    var to_client_name = content.to_client_name;
                    var content = content.content;
                    var money = content.money;
                    console.log(money);
                    ws.send('{"type":"red_receive","user_level":"'+user_level+'","to_client_id":"'+to_client_id+'","to_client_name":"'+to_client_name+'","money":"'+money+'","content":"'+content+'"}');
                    $(".mask,.redPacket-popup").hide();
                }else{
                    alert(data.msg);
                }
            }
        })
    }

    //用户抢红包
    function red_receive(from_client_id, from_client_name, money, content, time){
        console.log(content);
        var str = '';
        str +='<div class="open-status">';
        str +='<div class="popup-header">';
        str +='<h3 style="margin-top: 13px;">红包</h3>';
        str +='</div>';
        str +='<div class="popup-body">';
        str +='<h3>获得红包</h3>';
        str +='<p><span class="amount-num">'+money+'</span> 元</p>';
        str +='</div>';
        str +='<div class="popup-footer"><div class="close-btn" onclick="closeRed();"></div></div>';
        str +='</div>';
        $(".enveloper-popup").append(str);
        $(".enveloper-popup").show();
        $(".open-status").show();
        $(".undemolished").hide();

    }

    //发购物链接
    function goods_url(from_client_id, from_client_name, content, time,goods_url){
        console.log(content);
        var str = '';
        str += '商品链接：<a href="'+goods_url+'">'+goods_url+'</a>';
        $(".goods-links").html(str);

    }

    $(function(){
        select_client_id = 'all';
        $("#client_list").change(function(){
            select_client_id = $("#client_list option:selected").attr("value");
        });
    });
</script>
</body>
</html>
</html>
